<include file="Common/top" />
<!-- 私有样式 -->
<link rel="stylesheet" href="__PUBLIC__/home/css/list.css">
<style type="text/css">
	body { background-color:#f3f5f6; }
</style>

	<!-- 主要内容 -->
	<div id="content">

		<!-- 面包屑导航 -->
		<div class="bread-nav">
			<volist id="nav" name="navigation">
				<php>$param = $param.'/m'.$key.'/'.$nav['id'];</php>
				<if condition="$key egt (count($navigation) - 1)">
					> <a style="color: #f60;" href="javascript:;">{$nav.item_desc}</a>
				<else />
					> <a href="{:U('line/list')}{$param}">{$nav.item_desc}</a>
				</if>				
			</volist>
			<script type="text/javascript">
//				$(document).ready(function(){
//					$('.bread-nav').find('a:last').addClass('bread-final');
//					$('.bread-nav').find('a:last').attr('href','javascript:;');
//				});
			</script>
		</div>
		<!-- 商品菜单 -->
		<div class="commodity-menu">
			<ul class="select">
				<li class="select-mine">
					<div class="select-head">
						<span>您的选择:</span>
					</div>
					<div class="select-body">
						<a class="select-clear" href="javascript:;">清除筛选条件</a>
					</div>
				</li>
				<li class="select-list">
					<div class="select-head">
						<span>产品主题:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-cpzt select-list">
						<volist id="lt" name="line_theme">
							<if condition="$lt.type_desc neq '新旅拍'">
								<a href="javascript:;" data-id="{$lt.id}">{$lt.type_desc}</a>
							</if>
						</volist>
					</div>
					<div class="select-foot">
						
					</div>
				</li>
				<li class="select-list">
					<div class="select-head">
						<span>产品区域:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-cpqy select-list">
						<volist id="la" name="line_area">
							<a href="javascript:;" data-id="{$la.id}">{$la.type_desc}</a>
						</volist>
					</div>
					<div class="select-foot">
						
					</div>
				</li>
				<li>
					<div class="select-head">
						<span>目的地:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-mdd select-list">
						<volist id="d" name="dest">
							<a href="javascript:;" data-id="{$d.id}">{$d.type_desc}</a>
						</volist>		
					</div>
					<div class="select-foot">
						<a class="select-more select-more02" href="javascript:;">更多<i class="show-more"></i></a>
					</div>
				</li>
				<li class="select-hide">
					<div class="select-head">
						<span>包含景点:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-jd select-list multiselect">
						<volist id="vp" name="view_point">
							<a href="javascript:;"  data-id="{$vp.id}">
								<span class="no-checked multiselect-span multiselect-hide"></span>
								<span>{$vp.type_desc}</span>
							</a>
						</volist>						
						<div class="btns btn-hide">
							<button type="button" class="btn-submit">确定</button>
							<button type="button" class="btn-cancel">取消</button>
						</div>
					</div>
					<div class="select-foot">
						<a class="select-checkbox" href="javascript:;"><span>+</span>多选</a>
						<a class="select-more select-more01" href="javascript:;">更多<i class="show-more"></i></a>
					</div>
				</li>
				<li class="select-hide">
					<div class="select-head">
						<span>集合地:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-cfd select-list">
						<volist id="ap" name="assembly_place">
							<a href="javascript:;" data-id="{$ap.id}">{$ap.type_desc}</a>
						</volist>	
					</div>
				</li>
				
				<li class="select-hide">
					<div class="select-head">
						<span>旅行时间:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-lxsj select-list">
						<volist id="m" name="month">
							<a href="javascript:;" data-id="{$m.id}">{$m.type_desc}</a>
						</volist>	
					</div>
				</li>
				<li class="select-hide">
					<div class="select-head">
						<span>行程天数:</span>
						<a class="select-all" href="javascript:;" data-id="-1">全部</a>
					</div>
					<div class="select-body select-xcts select-list ">
						<for start="1" end="31">
							<a href="javascript:;" data-id="{$i}">{$i}天</a>
						</for>
					</div>
				</li>
			</ul>
			<a class="select-up-down" href="javascript:;">
				<span>查看更多选项<i class="show-more"></i></span>
			</a>
		</div>
		<!--单排列表模板-->		
		<div class="single-row-content template_single_row hidden_ctrl">
			<a href="javascript:;" target="_blank"></a>
			<div class="single-row-img">
				<img src="" alt="">
			</div>
			<div class="jiriyou">
				<p><span class="day"></span>日游</p>
			</div>
			<div class="single-row-describe">
				<div class="single-row-describe-top">
					<h4 class="title"><span class="span"></span><span class="subheading"></span></h4>
					<span class="send_word"></span>
					<p><u class="assembly">集合地点：</u><u class="batch">批次：全年0期</u></p>
					<p class="destination">目的地：</p>
					<div class="single-row-describe-price">
						<h6><!--<s class="price">0元</s>--><strong class="cut_price"></strong>元起</h6>
					</div>
				</div>
				<div class="single-row-describe-bottom">
					<span class="travel_date">旅行时间：</span>
					<em class="appointment""></em>
				</div>
			</div>
		</div>

		<!--双排列表模板-->
		<div class="double-row-content template_double_row hidden_ctrl">
			<div class="template_content"> <!--double-row-left/double-row-right-->
				<a href="javascript:;" target="_blank"></a>
				<div class="template_img"> <!--double-row-left-top/double-row-right-top-->
					<img src="" alt="">
				</div>
				<div class="jiriyou">
					<p><span class="day"></span>日游</p>
				</div>
				<div class="double-row-describe">
					<h4 class="title"></h4>
					<h5 class="subheading"></h5>
					<p class="send_word describe-content"></p>
					<p><u class="assembly">集合地点：</u><u class="batch">批次：全年0期</u></p>
					<p class="destination">目的地：</p>
					<div class="double-row-describe-price">
						<h6><!--<s class="price">0元</s>--><strong class="cut_price"></strong>元起</h6>
					</div>
				</div>
			</div>
		</div>
		<!-- 列表菜单 -->
		<div class="list-menu">
			<div class="list-menu-sort">
				<div class="list-menu-sort-left">
					<a class="list-menu-sort-comprehensive sort-checked" href="javascript:;">综合排序</a>
					<a class="list-menu-sort-sales" href="javascript:;">销量<i></i></a>
					<!--<a class="list-menu-sort-price" href="javascript:;">价格<i></i></a>-->
				</div>
				<div class="list-menu-sort-right">
					<a class="list-menu-sort-y" href="javascript:;"><i class="sort-y"></i></a>
					<a class="list-menu-sort-x" href="javascript:;"><i></i></a>
				</div>
			</div>

			<!-- 单排列表 -->
			<div class="single-row">
				<volist id="line" name="lines">
					<div class="single-row-content" data-id="{$line.id}">
						<a href="{:U('line/info')}/id/{$line.id}" target="_blank"></a>
						<div class="single-row-img">
							<img src="{$line.img1}" alt="">
						</div>
						<div class="jiriyou">
							<p><span class="day">{$line.travel_day}</span>日游</p>
						</div>
						<div class="single-row-describe">
							<div class="single-row-describe-top">
								<h4 class="title"><span class="span">【{$line.title}】</span><span class="subheading">{$line.subheading}</span></h4>

								<span class="send_word">{$line.send_word_show}</span>
								<p>
									<u class="assembly">集合地点：{$line.assembly_point_show_text}</u>
									<u class="batch">批次：全年{:count($line['batchs'])}期</u>
								</p>
								<p class="destination">目的地：{$line.destination_show_text}</p>
								<div class="single-row-describe-price">
									<h6>
										<if condition="empty($line['check_price'])">
											<strong class="cut_price">核算中</strong>
										<else />
											<strong class="cut_price">{$line.start_price_adult}</strong>元起
										</if>
									</h6>
								</div>
							</div>
							<div class="single-row-describe-bottom">
								<span class="travel_date">旅行时间： {$line.start_time}&nbsp;至&nbsp;{$line.end_time}</span>
								<em class="appointment" href="{:U("line/info")}/id/{$line.id}"></em>
							</div>
						</div>
					</div>
				</volist>
			</div>
			<!-- 双排列表 -->
			<div class="double-row">
				<volist id="line" name="lines" >
					<if condition="$key % 2 eq 0" >
						<div class="double-row-content">
							<div class="double-row-left">
								<div class="double-row-left-top">
					<else />
							<div class="double-row-right">
								<div class="double-row-right-top">
					</if>
									<img src="{$line.img1}" alt="">
								</div>
								<div class="jiriyou">
									<p><span class="day">{$line.travel_day}</span>日游</p>
								</div>
								<a href="{:U('line/info')}/id/{$line.id}" target="_blank"></a>
								<div class="double-row-describe">
									<h4 class="title">{$line.title}</h4>
									<h5 class="subheading">{$line.subheading_show}</h5>
									<p class="send_word describe-content">{$line.send_word_show}</p>
									<p>
										<u class="assembly">集合地点：{$line.assembly_point_show_text}</u>
										<u class="batch">批次：全年{:count($line['batchs'])}期</u>
									</p>
									<p class="destination">目的地：{$line.destination_show_text}</p>
									<div class="double-row-describe-price">
										<h6>
											<if condition="empty($line['check_price'])">
												<strong class="cut_price">核算中</strong>
											<else />
												<strong class="cut_price">{$line.start_price_adult}</strong>元起
											</if>
										</h6>
									</div>
								</div>
							</div>
					<if condition="$key % 2 gt 0">
						</div> <!--double-row-content 结束符-->
					</if>
				</volist>
					<!--数据为单数时添加double-row-content 结束符-->
					<if condition="count($lines) % 2 gt 0">
						</div> <!--double-row-content 结束符-->
					</if>
			</div>
			<!--<if condition="empty($lines) eq true">
				<span class="no-more-data" style="text-indent:2em;">领袖户外暂时没有你所要查询的信息，产品经理们正在努力开发线路中...</span>
			</if>-->
			<!-- 翻页 -->
			<div class="list-page" data-page-count="{$page_count}" data-page-index="1"></div>
		</div>
	</div>
	<!-- 私人定制 -->
	<include file="Common/private_book" />
 	<!-- 精彩专题 -->
	<include file="Common/zhuanti" />
	<!-- 为什么选择我们 -->
	<include file="Common/choose_us" />
	<!-- 分页 -->
	<script src="__PUBLIC__/home/js/page.js"></script>
	<!--图片延迟加载-->
	<script type="text/javascript" src="__PUBLIC__/qinglvpai/common/js/jquery.lazyload.js"></script>
	<script type="text/javascript">
		jQuery(document).ready(
			function($){
				$("img").lazyload({
					placeholder : "__PUBLIC__/qinglvpai/common/js/grey.gif",
					effect      : "fadeIn",
					threshold : 100,
					failure_limit : 10
				});
			});
	</script>
	<script type="text/javascript">
//		$('.appointment').click(function(){
//			location.href = '{:U("line/info")}/id/'+$(this).closest('.single-row-content').attr('data-id');
//		});

		// 添加已选条件
		function appendCondition(rootClass, did, type, only) {
			var aObj = $('.'+rootClass).find('a[data-id="'+did+'"]');
			var did = $(aObj).attr('data-id');
			var dtext = $(aObj).html();

			var vhtml = '<a class="'+ rootClass +'0" href="javascript:;" data-id="'+did+'">'
					  + '	<b class="b0">'+type+'</b>'
					  + '	<b class="b1">'+dtext+'</b>'
					  + '	<span></span>'
					  + '</a>';

			$('.select-mine').show();
			if (only != null) {
				$('.select-mine .select-body' + ' .' + rootClass + '0' ).remove();
			}
			$('.select-mine .select-body').prepend(vhtml);
		}

		// 初始化已选条件
		var curTheme = null;
		function initCondition() {
			var cdsstr = '{$cdsstr}';
			console.log('initialize condition:'+cdsstr);
			if (cdsstr != '') {
				var vhtml = '';
				var cdList = cdsstr.split('|');
				for (var i=0; i<$(cdList).length; i+=2) {
					var key = cdList[i];
					var val = cdList[i+1];
					if (cdList[i] == 'c0') {
						curTheme = cdList[i+1];
						appendCondition('select-cpzt', cdList[i+1], '产品主题-', true);
					} else if (key == 'c1') {
						appendCondition('select-mdd', cdList[i+1], '目的地-', true);
					} else if (key == 'c2') {
						appendCondition('select-jd', cdList[i+1], '包含景点-');
					} else if (key == 'c3') {
						appendCondition('select-cfd', cdList[i+1], '集合地-', true);
					} else if (key == 'c4') {
						appendCondition('select-lxsj', cdList[i+1], '旅行时间-', true);
					} else if (key == 'c5') {
						appendCondition('select-xcts', cdList[i+1], '行程天数-', true);
					} else if (key == 'c6') {
						appendCondition('select-cpqy', cdList[i+1], '产品区域-', true);
					}
				}
			}
		}

		$(document).ready(function(){
			// 初始化已选条件
			initCondition();
			// 从第二页还是加载
			pageIndex = 1;
			// 绑定滚动事件
			$(document).scroll(scrollDocument);	
		});

		// 获取基本信息
		function getConditions() {
			var cdsstr = '';
			var aObj = $('.select-mine').find('.select-body').find('a').each(function(i,el){
//				var txt = $(this).find('.b1').text()
				var cdstr = '';
				var did = $(this).attr('data-id');
				if ($(this).hasClass('select-cpzt0')) {
					cdstr = 'c0|'+did;
					curTheme = did;
				} else if ($(this).hasClass('select-mdd0')) {
					cdstr = 'c1|'+did;
				} else if ($(this).hasClass('select-jd0')) {
//					var t = textstr.replace(/(^\s*)|(\s*$)/g, "");
					cdstr = 'c2|'+did;
				} else if ($(this).hasClass('select-cfd0')) {
					cdstr = 'c3|'+did;
				} else if ($(this).hasClass('select-lxsj0')) {
					cdstr = 'c4|'+did;
				} else if ($(this).hasClass('select-xcts0')) {
//					var day = daystr.substring(0,daystr.length - 1);
					cdstr = 'c5|'+did;
				} else if ($(this).hasClass('select-cpqy0')) {
					cdstr = 'c6|'+did;
				}
				if (cdstr != '') {
					if (cdsstr != '') {
						cdsstr += '|';
					}
					cdsstr += cdstr;
				}
			});
			return cdsstr;
		}

		// 获取排序规则
		function getSorts() {
			var ssort = '';
			var sortObj = $('.list-menu-sort').find('.sort-checked');
			var iclass = $(sortObj).find('i').attr('class');
			if ($(sortObj).hasClass('list-menu-sort-sales')) {
				ssort = 'sell_count|'+(iclass == ''?'desc':'asc');
			} else if ($(sortObj).hasClass('list-menu-sort-price')) {
				ssort = 'start_price_adult|'+(iclass == ''?'desc':'asc');
			}
			return ssort;
		}

		// 初始化页码数据
//		constructionPage('.list-page', 1, '{$page_count}', findLine, true);

		// 查找产品
		var pageIndex = 0, bLoading = false, bEnd = false;
//		function findLine(pageIndex, brefresh) {
		function findLine(brefresh) {
		    if (brefresh != null && brefresh != false) {
                bEnd = false;
			}
		    if (bLoading == true || bEnd == true) {
		        return false;
			}

			var jsonData = {
//				page: pageIndex - 1,
				page: pageIndex,
				cds: getConditions(),
				sorts: getSorts(),
				refresh: brefresh,
			}

			console.log(JSON.stringify(jsonData));
            bLoading = true;
			$.post('{:U("line/list")}', jsonData, function(data){
                bLoading = false;
				if (data.jumpUrl != null) {
					location.href = data.jumpUrl;
					return false;
				}

				if (data.result.errno == 0) {
				    pageIndex ++;
				    if (brefresh != null && brefresh != false) {
						$('.single-row').empty();
						$('.double-row').empty();	
				    }
					if (data.ds != null && data.ds != 'undefined') {
						if ($('.no-more-data').length > 0) {
							console.log('开始加载新数据...');
							$('.no-more-data').addClass('hidden_ctrl');
                            bEnd = false;
						}

						for (var i=0; i < data.ds.length; i++) {
							var d = data.ds[i];
							// 单排
							var lineObj = $('.template_single_row').clone(true);
							$(lineObj).removeClass('hidden_ctrl');
							$(lineObj).removeClass('template_single_row');
							$(lineObj).attr('data-id', d.id);

							$(lineObj).find('img').attr('src',d.img1);
							$(lineObj).find('.day').html(d.travel_day);
							$(lineObj).find('.title .span').html('【'+ d.title +'】');
							$(lineObj).find('.subheading').html(d.subheading);
							$(lineObj).find('.send_word').html(d.send_word_show);
							$(lineObj).find('a').attr('href','{:U("line/info")}/id/'+ d.id);
							$(lineObj).find('.assembly').html('集合地点：'+d.assembly_point_show_text);
							$(lineObj).find('.batch').html('批次：全年'+d.batchs==null?0:$(d.batchs).length+'期');
							$(lineObj).find('.destination').html('目的地：'+d.destination_show_text);
							if (d.check_price == 0) {
								$(lineObj).find('.cut_price').parent().html('<strong class="cut_price">核算中</strong>');
							} else {
								$(lineObj).find('.cut_price').html(d.start_price_adult);
							}
							$(lineObj).find('.travel_date').html('旅行时间： '+d.start_time+'&nbsp;至&nbsp;'+d.end_time);
							$('.single-row').append(lineObj);

							// 双排
							var mLineObj = null, mRootObj = null, mContentClass = '', mImageClass = '';
							if (i % 2 == 0) {
								mRootObj = $('.template_double_row').clone(true);
								$(mRootObj).removeClass('template_double_row');
								$(mRootObj).removeClass('hidden_ctrl');
								mLineObj = $(mRootObj).find('.template_content');
								mContentClass = 'double-row-left';
								mImageClass = 'double-row-left-top';
							} else {
								mRootObj = $('.double-row').find('.double-row-content:last');
								mLineObj = $('.template_double_row').find('.template_content').clone(true);
								mContentClass = 'double-row-right';
								mImageClass = 'double-row-right-top';
							}

							$(mLineObj).removeClass('template_content');
							$(mLineObj).addClass(mContentClass);
							$(mLineObj).attr('data-id', d.id);
							var imgObj = $(mLineObj).find('.template_img');
							$(imgObj).removeClass('template_img');
							$(imgObj).addClass(mImageClass);
							$(imgObj).find('img').attr('src',d.img1);
							$(mLineObj).find('.day').html(d.travel_day);
							$(mLineObj).find('.title').html(d.title);
							$(mLineObj).find('.subheading').html(d.subheading_show);
							$(mLineObj).find('.send_word').html(d.send_word_show);
							$(mLineObj).find('a').attr('href','{:U("line/info")}/id/'+ d.id);
							$(mLineObj).find('.assembly').html('集合地点：'+d.assembly_point_show_text);
							$(mLineObj).find('.batch').html('批次：全年'+d.batchs==null?0:$(d.batchs).length+'期');
							$(mLineObj).find('.destination').html('目的地：'+d.destination_show_text);
//							$(mLineObj).find('.price').html(d.start_price_adult+'元');
							if (d.check_price == 0) {
								$(mLineObj).find('.cut_price').parent().html('<strong class="cut_price">核算中</strong>');
							} else {
								$(mLineObj).find('.cut_price').html(d.start_price_adult);
							}
							if (i % 2 == 0) {
								$('.double-row').append(mRootObj);
							} else {
								$(mRootObj).append(mLineObj);
							}
						} // end for
					} else {
						if ($('.no-more-data').length > 0) {
							$('.no-more-data').removeClass('hidden_ctrl');
							console.log('没有更多的数据可供加载...');
                            bEnd = true;
						} else {
//							var vhtml = '<span class="no-more-data" style="text-indent:2em;">领袖户外暂时没有你所要查询的信息，产品经理们正在努力开发线路中...</span>';
//							$('.list-page').before(vhtml);
							console.log('没有更多的数据可供加载1...');
                            bEnd = true;
						}
					}

					// 判断页面总数是否发生变化
//					constructionPage('.list-page', pageIndex, data.page_count, findLine);
//					double('.double-row-left', '.double-row-left-top');
//					double('.double-row-right', '.double-row-right-top');
				} else {
					console.log(data.result.message);
				}
			});
		}

		// 查询线路
		function refreshLine() {
//			var thisPageIndex = $('.list-page').attr('data-page-index');
//			findLine(thisPageIndex, 1);
			pageIndex = 0;
			findLine(1);
		}
		
		//滚动加载
//    	var lastBottom = null;
//		$(document).scroll(function(){
//	    	var b = $(document).scrollTop()+$(window).height();
//	    	if (lastBottom != null && lastBottom > b) {
//	    		return false;
//	    	}
//	    	lastBottom = b;
//	    	var destB = $('.list-page').offset().top + $('.list-page').height();
//	    	if (destB - b < 500) {
//	    		findLine();
//	    	}
//		});

		function scrollDocument() {
			var bheight = $(document).height();//获取窗口高度
			var sheight = $("body")[0].scrollHeight;//获取滚动条高度，[0]是为了把jq对象转化为js对象
			var stop = $("body").scrollTop();//滚动条距离顶部的距离
			if(stop>=sheight-bheight){
                findLine();
			}
		}
		
// 重置查询条件
		function resetCondition() {
			$.post('{:U("line/resetcd")}', '', function(){
				refreshLine();
			});
		}

	</script>

<include file="Common/right" />
<include file="Common/bottom" />
<!-- 私有js -->
<script src="__PUBLIC__/home/js/list.js"></script>