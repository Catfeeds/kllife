<include file="Common/header" /> 
<style>

	.form-control { width: 30%; }

	.form-control:focus { border-color: #40bbea; }

	.chaxun { margin-right: 100px; margin-bottom: 30px; }

	#activitySelectBoxIt ,#team_stateSelectBoxIt { border-radius: 0 15px 15px 0 ; background-color: #fff; border-color: #40bbea; overflow: hidden; }

	#activitySelectBoxItOptions , #team_stateSelectBoxItOptions { border-radius: 0 15px 15px 15px; background-color: #fff; border-color: #40bbea; }

	#activitySelectBoxItOptions li a , #team_stateSelectBoxItOptions li a { color: #000; }



	.selectboxit-option-icon-container { overflow: hidden; }

	.cx_border01 { border-radius: 15px 0 0 15px; border-color: #40bbea; }

	.cx_border02 , html .select2-container .select2-choice , #s2id_activity{ border-radius: 0 15px 15px 0 !important; border-color: #40bbea !important; }

	.tab-pane > div { margin-top: 10px; height: 35px; }

	.ctr_card_btn_num:focus { border-color: #40bbea; }

	.dropdown-menu.dropdown-info > li > a { color: #000; }

	.dropdown-menu.dropdown-info > li > a:hover { background-color: #999 !important; }

	.nav.nav-tabs > li.active > a { border: 1px solid #40bbea; border-bottom: 2px solid #fff; }

	.nav.nav-tabs > li > a { padding-left: 30px; padding-right: 30px; }

	.nav.nav-tabs > li > a:hover { background-color: #40bbea; color: #fff; }

	.hvr-curl-top-left {

	  display: inline-block;

	  vertical-align: middle;

	  -webkit-transform: translateZ(0);

	  transform: translateZ(0);

	  box-shadow: 0 0 1px rgba(0, 0, 0, 0);

	  -webkit-backface-visibility: hidden;

	  backface-visibility: hidden;

	  -moz-osx-font-smoothing: grayscale;

	  position: relative;

	}

	.hvr-curl-top-left:before {

	  pointer-events: none;

	  position: absolute;

	  content: '';

	  height: 0;

	  width: 0;

	  top: 0;

	  left: 0;

	  background: white;

	  /* IE9 */

	  background: linear-gradient(135deg, white 45%, #aaaaaa 50%, #cccccc 56%, white 80%);

	  filter: progid:DXImageTransform.Microsoft.gradient(GradientType=0,startColorstr='#ffffff', endColorstr='#000000');

	  /*For IE7-8-9*/

	  z-index: 1000;

	  box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.4);

	  -webkit-transition-duration: 0.3s;

	  transition-duration: 0.3s;

	  -webkit-transition-property: width, height;

	  transition-property: width, height;

	}

	.hvr-curl-top-left:hover:before, .hvr-curl-top-left:focus:before {

	  width: 15px;

	  height: 15px;

	}

	.info-color { background-color: #40bbea !important; border-color: #40bbea !important; }

	.info-border-color { border-color: #40bbea !important; }

	.select2-arrow { color: #fff !important; }

	#select2-drop { border-color: #40bbea;  } 

	.mybtn { margin-left: 0 !important; }

	.dataTables_wrapper table.dataTable thead > tr > th { padding: 15px 0px 15px 0px; }

	.selectboxit-btn { background-color: #fff; border-color: #40bbea; } 

	.selectboxit-list { background-color: #fff; border-color: #40bbea; }
	
	.selectboxit-list .selectboxit-option-anchor { color: #000; }

	.selectboxit-container .selectboxit-options { border-radius: 0 0 0 15px; }

	#team_stateSelectBoxItOptions { border-radius: 0 0 0 15px; }

	.selectboxit-container .selectboxit { border-radius: 0 15px 15px 0 !important; }

	.selectboxit-arrow-container { background-color: #40bbea; }

	.selectboxit-arrow-container i { color: #fff; }
</style>
	<div class="row">
		<div class="panel panel-color panel-info panel-content-pos">
			<div class="panel panel-heading">
				<span class="description">{:C(CONTENT_TITLE)}</span>					
			</div>
			<div class="panel panel-color panel-content">
				<!-- 查询 -->
				<div class="row chaxun">
					<!-- tab标签 -->
					<div class="col-sm-12">
						<div class="tab-content"  style="border-top: 1px solid #40bbea; margin-top: -1px;">
							<div class="tab-pane active" id="order">
							
								<div class="col-sm-3">
									<div class="input-group">
										<span class="input-group-addon info-color text-white cx_border01">操作人员类型:</span>
										<script type="text/javascript">
												jQuery(document).ready(function($)
												{
													$("#op_admin_type").selectBoxIt({
														showEffect: 'fadeIn',
														hideEffect: 'fadeOut'
													});
												});
										</script>
										<select class="form-control" name="" id="op_admin_type">
											<option value="-1">不限</option>
											<notempty name="acctTypes">
												<volist id="acct" name="acctTypes">	
													<option value="{$acct.type_key}">{$acct.type_desc}</option>
												</volist>
											</notempty>
										</select>
									</div>
								</div>

								<div class="col-sm-3">
									<div class="input-group">
										<span class="input-group-addon info-color text-white cx_border01">操作人员:</span>
										<input type="text" class="form-control cx_border02" id="op_admin">
									</div>
								</div>
							
								<div class="col-sm-3">
									<div class="input-group">
										<span class="input-group-addon info-color text-white cx_border01">操作类型:</span>
										<script type="text/javascript">
												jQuery(document).ready(function($)
												{
													$("#op_type").selectBoxIt({
														showEffect: 'fadeIn',
														hideEffect: 'fadeOut'
													});
												});
										</script>
										<select class="form-control" name="" id="op_type">
											<option value="-1">不限</option>
											<notempty name="opType">
												<volist id="type" name="opType">	
													<option value="{$type.id}">{$type.type_desc}</option>
												</volist>
											</notempty>
										</select>
									</div>
								</div>

								<div class="col-sm-3">
									<div class="input-group">
										<span class="input-group-addon info-color text-white cx_border01">操作表:</span>
										<script type="text/javascript">
												jQuery(document).ready(function($)
												{
													$("#op_table").selectBoxIt({
														showEffect: 'fadeIn',
														hideEffect: 'fadeOut'
													});
												});
										</script>
										<select class="form-control" name="" id="op_table">
											<option value="-1">不限</option>
											<notempty name="tabs">
												<volist id="tab" name="tabs">	
													<option value="{$tab.table_name}">{$tab.table_name}{$tab.table_desc}</option>
												</volist>
											</notempty>
										</select>
									</div>
								</div>

								<div class="col-sm-3">
									<div class="input-group">
										<span class="input-group-addon info-color text-white cx_border01">操作内容:</span>
										<input type="text" class="form-control cx_border02" id="op_content">
									</div>
								</div>
								
								<div class="col-sm-6">
									<div class="input-group">			
										<span class="input-group-btn">
											<button id="date_type" type="button" class="btn btn-info dropdown-toggle cx_border01" data-toggle="dropdown" data-id="request" style="background-color: #40bbea; color: #555;">
												<span class="ctr_card_btn_num" style="background-color: #40bbea; color: #fff;">提交时间</span> 
											</button>
										</span>
										<input type="text" class="form-control datepicker info-border-color" style="display: inline-block;" data-format="yyyy-mm-dd" id="start_date">
										<div class="input-group-addon info-color text-white" style="border-radius: 0 15px 15px 0;">
											<a href="#"><i class="linecons-calendar text-white"></i></a>
										</div>
										<span style="display: table-cell; vertical-align: middle;">&nbsp;到&nbsp;</span>
										<input type="text" class="form-control datepicker info-border-color" style="display: inline-block; border-radius:15px 0 0 15px;" data-format="yyyy-mm-dd" id="end_date">
										<div class="input-group-addon info-color text-white cx_border02">
											<a href="#"><i class="linecons-calendar text-white"></i></a>
										</div>
									</div>
								</div>		
													
							</div>					
						</div>
				
						<button class="btn btn-blue btn-icon btn-icon-standalone btn-icon-standalone-right" id="button_search" style="float: right; margin-top: 30px;">
							<i class="fa-search"></i>
							<span>查 询</span>
						</button>
						<button class="btn btn-warning btn-icon btn-icon-standalone btn-icon-standalone-right" id="button_reset" style="float: right; margin-top: 30px; margin-right: 10px;">
							<i class="fa-refresh"></i>
							<span>重 置</span>
						</button>
					</div>
				</div>
                <table id="test" class="table aspTable lcnp" cellpadding="0" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th width="3%"><input type="checkbox" id="checkAll" /></th>
                            <th width="10%">操作者</th>
                            <th width="5%">操作类型</th>
                            <th width="15%">操作表</th>
                            <th width="10%">操作时间</th>
                            <th>操作内容</th>
                        </tr>
                    </thead>
                </table>   
                
				<div class="row">
					<a href="#" class="btn btn-danger" id="btn_delete_type">删除日志</a>
				</div>
			</div>
		</div>		
	</div>
<include file="Common/footer" />
<script type="text/javascript">
	var myTable, pageRequestData;
	var modalDataEditData = new Object();
	$(document).ready(function(){
		
		// 初始化数据表格
		myTable = initDataTable();
		
		// 删除选中的
		$("#btn_delete_type").click(_deleteList);
		
		//checkbox全选
		$("#checkAll").click(function () {
		    $("input[name='checkList']").prop("checked", $(this).prop('checked'));
		});
		
		// 开始查询
		$('#button_search').click(function(){myTable.fnReloadAjax();});
		
		// 重置查询条件
		$('#button_reset').click(resetFindConds);
	});
		
	// 重置查询条件
	function resetFindConds() {
		 
		$('#op_admin').val(-1).trigger('change');
		 
		$('#op_admin_type').val(-1).trigger('change');			
		 
		$('#op_type').val(-1).trigger('change');	
		
		$('#op_table').val(-1).trigger('change');	
		
		$('#op_content').val('');

		$('#start_date').val('');

		$('#end_date').val('');
		
		myTable.fnReloadAjax()
	}
	
	// 初始化数据列表
	function initDataTable() {	
		var vTable = $(".aspTable").dataTable({
			"bSort": true,
			"searching": false,
			"bAutoWidth": true,
			"bFilter": true,
			"bInfo": true,//页脚信息
			"bPaginate": true, //翻页功能
			"bLengthChange": true, //改变每页显示数据数量
			"bStateSave": true,	//状态保存，使用了翻页或者改变了每页显示数据数量，会保存在cookie中，下回访问时会显示上一次关闭页面时的内容。
			"sPaginationType": "full_numbers", //显示数字的翻页样式"
			"aLengthMenu": [[5, 10, 25, 50, 100],[5, 10, 25, 50, 100]],	// 可分页的数量值与显示
			"isDisplayLength": 5,	// 当前每页显示数量
			"oLanguage": {
				"sLengthMenu": "每页显示 _MENU_ 条记录",
				"sZeroRecords": "抱歉， 没有找到",
				"sInfo": "从 _START_ 到 _END_ / 共 _TOTAL_ 条数据",
				"sInfoEmpty": "没有数据",
				"sInfoFiltered": "(从_MAX_条数据中检索)",
				"oPaginate": {
					"sFirst": "首页",
					"sPrevious": "前一页",
					"sNext": "后一页",
					"sLast": "尾页"
				},
				"sZeroRecords": "没有检索到数据",
				"sProcessing": "<src='__PUBLIC__/images/loader.gif' />",
			},
			//Ajax获取信息
			"bProcessing": true,
			"bServerSide": true,
			"sAjaxSource": "{:U('settle/loglist')}",
			//如果加上下面这段内容，则使用post方式传递数据
			"fnServerData": getPageData,
			"aoColumns": [
				{"bSortable": false, "mDataProp":"id", "bSearchable": false, "aTargets": [0], "fnCreatedCell": appendFirstCol},
				{"mData": "admin_id", "aTargets": [1], "fnCreatedCell": replaceContent},
				{"mData": "op_type_id.type_desc", "aTargets": [2], "fnCreatedCell": replaceContent},
				{"mData": "table_name", "aTargets": [3]},
				{"mData": "create_time", "aTargets": [4]},
				{"mData": "content", "aTargets": [5]},
			],//$_GET[‘sColumns’]将接收到aoColumns传递数据
			"aoColumnDefs": [{"sDefaultContent": "", "aTargets": ["_all"]}],
		});
		return vTable;
	}

	//Ajax获取数据
	function getPageData ( sSource, aoData, fnCallback ) {
//		showLoading(true);		
		var cdsstr = 'op_admin|'+$('#op_admin').val();
			cdsstr += '|op_admin_type|'+$('#op_admin_type').val();
			cdsstr += '|op_type|'+$('#op_type').val();
			cdsstr += '|op_table|'+$('#op_table').val();
			cdsstr += '|op_content|'+$('#op_content').val();
			cdsstr += '|sdate|'+$('#start_date').val();
			cdsstr += '|edate|'+$('#end_date').val();
			
		aoData.push({'name':'op_type','value':'list'});
		aoData.push({'name':'cds','value': cdsstr});
//		alert(JSON.stringify(aoData));
		pageRequestData = aoData;
		$.post(sSource, aoData, function(data,status){
//				console.log(JSON.stringify(data));
//				alert(JSON.stringify(data));
				if (data['result']['errno'] == 0) {
					if (data.aaData == null || data.aaData == '') {
						toastr.warning('没有查到任何数据');
					}
					fnCallback(data);
				} else {
					toastr.warning(data['result']['message']);
				}			
//				showLoading(false);
			},'JSON');
	}

	// 添加第一列复选框
	function appendFirstCol(nTd, sData, oData, iRow, iCol) {
	//	alert(nTd+'|'+JSON.stringify(sData)+'|'+JSON.stringify(oData)+'|'+iRow+'|'+iCol);
		$(nTd).html('<input type="checkbox" name="checkList" value=' + sData + '/>'); 
	}
	
	// 内容替换
	function replaceContent(nTd, sData, oData, iRow, iCol) {
		if (iCol == 1) {
			if (oData.admin_id != 0) {
				var acctTypeDesc = '未知', acctShowName = '未命名';
				if (oData.acct.account_type != null) {
					acctTypeDesc = oData.acct.account_type.type_desc;
				}
				if (oData.acct.show_name != null) {
					acctShowName = oData.acct.show_name;
				}
				$(nTd).html('['+acctTypeDesc+']'+acctShowName+'('+oData.acct.id+')');	
			} else {
				$(nTd).html('系统自动');
			}
		} else if (iCol == 2) {
			if (oData.op_type != null) {
				$(nTd).html(oData.op_type.type_desc);
			} else {
				$(nTd).html('未知操作类型');
			}
		}
	}

	// 添加最后一列控件
	function appendLastCol(nTd, sData, oData, iRow, iCol) {
//		alert(nTd+'|'+JSON.stringify(sData)+'|'+JSON.stringify(oData)+'|'+iRow+'|'+iCol);
		var id = parseInt(oData['id']);
    	$(nTd).html('<a href="#" class="btn btn-secondary btn-sm btn-icon icon-left" onclick="_editFun('+id+')">查看</a>');
    	$(nTd).append('<a href="#" class="btn btn-danger btn-sm btn-icon icon-left" onclick="_deleteFun('+id+')">删除</a>');
	}

	/**
	* 删除
	* @param id
	* @private
	*/
	function _deleteFun(oData) {
		var id = oData;
		if (typeof oData == 'object') {
			id = oData['Id'];
		}
		if (!confirm("您确定要删除id=["+id+"]该条类型记录吗？")) {
			return false;
		}
		var typeObj = '{$typeObj}';
		$.post('{:U("settle/loglist")}',
			{type_obj:typeObj, op_type:'delete', id:id},
			function(data,status){
	        	if(data['result']['errno'] == 0){
		    		hideModalDataEdit();
					myTable.fnReloadAjax(myTable.fnSettings());
				} else {
					alert(data['result']['message']);	
				}
			});	
	}
	 
	/**
	* 批量删除
	* 未做
	* @private
	*/
	function _deleteList() {
		var ids = new Array();
		$("input[name='checkList']:checked").each(function (i, o) {
   			var selected = myTable.fnGetData($(o).parent('tr').get(2));
//			alert(i+"\n"+JSON.stringify(selected));
			var idstr = $(this).val();
			ids[ids.length]=parseInt(idstr.substr(0, idstr.length-1));
		});
		if (ids.length > 0) {
			if (!confirm("您确定要删除选定ID为["+JSON.stringify(ids)+"]的记录吗？")) {
				return false;
			}
			var typeObj = '{$typeObj}';
			$.post('{:U("settle/loglist")}',
				{type_obj:typeObj, 'op_type':'delete_multi', 'ids':ids},
				function(data,status){
		        	if(data['result']['errno'] == 0){
						myTable.fnReloadAjax(myTable.fnSettings());
					} else {
						alert(data['result']['message']);	
					}
				});
		} else {
		    alert("至少选择一条记录操作");
		}
	}


	/*
	add this plug in
	// you can call the below function to reload the table with current state
	Datatables刷新方法
	oTable.fnReloadAjax(oTable.fnSettings());
	*/
	$.fn.dataTableExt.oApi.fnReloadAjax = function (oSettings) {
		//oSettings.sAjaxSource = sNewSource;
		this.fnClearTable(this);
		this.oApi._fnProcessingDisplay(oSettings, true);
		var that = this;

		$.getJSON(oSettings.sAjaxSource, null, function (json) {
		    /* Got the data - add it to the table */
		    for (var i = 0; i < json.aaData.length; i++) {
		        that.oApi._fnAddData(oSettings, json.aaData[i]);
		    }
		    oSettings.aiDisplay = oSettings.aiDisplayMaster.slice();
		    that.fnDraw(that);
		    that.oApi._fnProcessingDisplay(oSettings, false);
		});
	}
	
</script>